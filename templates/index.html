<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard IT - Cl√≠nica Bonsana</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        /* Estilos para tickets sin asignar */
        .unassigned-alert {
            border-left: 4px solid #ff6b35 !important;
            background: linear-gradient(90deg, #fff3e0 0%, #ffffff 100%) !important;
            border-color: #ff6b35 !important;
            animation: pulseWarning 3s ease-in-out infinite;
        }

        .unassigned-alert .bi-exclamation-triangle-fill {
            color: #ff6b35;
            animation: bounce 2s infinite;
        }

        @keyframes pulseWarning {
            0%, 100% { 
                border-left-color: #ff6b35;
                background: linear-gradient(90deg, #fff3e0 0%, #ffffff 100%);
            }
            50% { 
                border-left-color: #e55a2b;
                background: linear-gradient(90deg, #ffe0cc 0%, #ffffff 100%);
            }
        }

        @keyframes bounce {
            0%, 20%, 60%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-5px);
            }
            80% {
                transform: translateY(-2px);
            }
        }

        .metric-card.warning-highlight {
            border-left: 4px solid #ff6b35;
            background: linear-gradient(135deg, #fff8f0 0%, #ffffff 100%);
        }

        .metric-card.warning-highlight .metric-value {
            color: #ff6b35;
        }
        :root {
            --bonsana-red: #dc3545;
            --bonsana-red-light: #f8d7da;
            --bonsana-red-dark: #b02a37;
            --bonsana-white: #ffffff;
            --bonsana-gray-light: #f8f9fa;
            --bonsana-gray: #6c757d;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
        }

        body {
            background-color: var(--bonsana-gray-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: linear-gradient(135deg, var(--bonsana-red) 0%, var(--bonsana-red-dark) 100%) !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        .metric-card {
            background: linear-gradient(135deg, var(--bonsana-white) 0%, #fafafa 100%);
        }

        .metric-card .card-body {
            padding: 1.5rem;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--bonsana-red);
        }

        .metric-label {
            color: var(--bonsana-gray);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-icon {
            font-size: 2rem;
            color: var(--bonsana-red);
            opacity: 0.8;
        }

        .section-title {
            color: var(--bonsana-red-dark);
            font-weight: bold;
            border-bottom: 3px solid var(--bonsana-red);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }

        .chart-container.small {
            height: 250px;
        }

        .alert-custom {
            border-left: 4px solid var(--bonsana-red);
            background-color: var(--bonsana-red-light);
            border-color: var(--bonsana-red);
        }

        .nav-pills .nav-link {
            color: var(--bonsana-red);
            border: 1px solid var(--bonsana-red);
            margin-right: 0.5rem;
        }

        .nav-pills .nav-link.active {
            background-color: var(--bonsana-red);
            border-color: var(--bonsana-red);
        }

        .nav-pills .nav-link:hover {
            background-color: var(--bonsana-red-light);
        }

        .table th {
            background-color: var(--bonsana-red);
            color: white;
            border: none;
        }

        .badge-custom {
            background-color: var(--bonsana-red);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(220, 53, 69, .3);
            border-radius: 50%;
            border-top-color: var(--bonsana-red);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .insight-item {
            border-left: 4px solid var(--bonsana-red);
            background-color: white;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0 8px 8px 0;
        }

        .trend-indicator {
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
        }

        .trend-up {
            background-color: var(--success-color);
            color: white;
        }

        /* Charts with values */
        .chart-container canvas {
            position: relative;
        }

        .chart-value {
            font-weight: bold;
            color: #333;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
        }

        .chart-value-white {
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        /* Better chart animations */
        .chart-container {
            animation: fadeIn 0.6s ease-in;
        }

        @keyframes chartValueFadeIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .chart-value {
            animation: chartValueFadeIn 0.8s ease-out 0.5s both;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-hospital me-2"></i>
                Cl√≠nica Bonsana - Dashboard IT
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text text-white">
                    <i class="bi bi-calendar-today me-1"></i>
                    <span id="currentDate"></span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Navigation Tabs -->
        <ul class="nav nav-pills mb-4" id="viewTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="pill" data-bs-target="#overview" type="button" role="tab">
                    <i class="bi bi-speedometer2 me-1"></i>Resumen General
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="analysis-tab" data-bs-toggle="pill" data-bs-target="#analysis" type="button" role="tab">
                    <i class="bi bi-graph-up me-1"></i>An√°lisis Detallado
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="technicians-tab" data-bs-toggle="pill" data-bs-target="#technicians" type="button" role="tab">
                    <i class="bi bi-people me-1"></i>Estad√≠sticas por T√©cnico
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="validation-tab" data-bs-toggle="pill" data-bs-target="#validation" type="button" role="tab">
                    <i class="bi bi-exclamation-triangle me-1"></i>Validaci√≥n de Datos
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="validation-tab" href="{{ url_for('ai_analysis') }}">
                    <i class="bi bi-robot me-1"></i> An√°lisis con IA Asistida
                </a>
            </li>

        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="tabContent">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <!-- Key Metrics Row -->
                <div class="row mb-4">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card metric-card">
                            <div class="card-body text-center">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="metric-value" id="totalTickets">-</div>
                                        <div class="metric-label">Total Tickets</div>
                                    </div>
                                    <i class="bi bi-ticket-perforated metric-icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card metric-card">
                            <div class="card-body text-center">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="metric-value" id="resolutionRate">-</div>
                                        <div class="metric-label">Tasa de Resoluci√≥n</div>
                                    </div>
                                    <i class="bi bi-check-circle metric-icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card metric-card">
                            <div class="card-body text-center">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="metric-value" id="avgResolutionTime">-</div>
                                        <div class="metric-label">Tiempo Promedio (hrs)</div>
                                    </div>
                                    <i class="bi bi-clock-history metric-icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card metric-card">
                            <div class="card-body text-center">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="metric-value" id="slaCompliance">-</div>
                                        <div class="metric-label">Cumplimiento SLA</div>
                                    </div>
                                    <i class="bi bi-shield-check metric-icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row mb-4">
                    <div class="col-lg-6 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-pie-chart me-2"></i>Distribuci√≥n por Tipo
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container small">
                                    <canvas id="typeDistributionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-bar-chart me-2"></i>Estado de Tickets
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container small">
                                    <canvas id="statusDistributionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Metrics Row -->
                <div class="row mb-4">
                    <div class="col-lg-4 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-exclamation-diamond me-2"></i>Distribuci√≥n por Prioridad
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container small">
                                    <canvas id="priorityChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-people me-2"></i>Carga por T√©cnico
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container small">
                                    <canvas id="technicianChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-emoji-smile me-2"></i>Satisfacci√≥n del Cliente
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="text-center">
                                    <div class="metric-value" id="csatScore">-</div>
                                    <div class="metric-label">CSAT Promedio</div>
                                    <small class="text-muted">
                                        <span id="csatSurveys">-</span> encuestas respondidas
                                    </small>
                                </div>
                                <div class="chart-container small mt-3">
                                    <canvas id="csatChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analysis Tab -->
            <div class="tab-pane fade" id="analysis" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-lg-8 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-graph-up me-2"></i>Top Categor√≠as de Problemas
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="categoryChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-person-check me-2"></i>Top Solicitantes
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="topRequesters">
                                    <div class="text-center">
                                        <div class="loading-spinner"></div>
                                        <p class="mt-2 text-muted">Cargando datos...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SLA Analysis -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-shield-exclamation me-2"></i>An√°lisis de SLA
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-lg-6">
                                        <h6>Resumen de Incidencias</h6>
                                        <div class="row">
                                            <div class="col-6">
                                                <div class="text-center p-3 bg-light rounded">
                                                    <div class="h4 text-primary" id="totalIncidents">-</div>
                                                    <small>Total Incidencias</small>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="text-center p-3 bg-light rounded">
                                                    <div class="h4 text-danger" id="slaExceeded">-</div>
                                                    <small>SLA Excedido</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-6">
                                        <h6>Cumplimiento por Nivel de SLA</h6>
                                        <div id="slaLevels">
                                            <div class="text-center">
                                                <div class="loading-spinner"></div>
                                                <p class="mt-2 text-muted">Cargando an√°lisis SLA...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Technicians Tab -->
            <div class="tab-pane fade" id="technicians" role="tabpanel">
                <!-- SLA por T√©cnico -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-shield-check me-2"></i>Cumplimiento de SLA por T√©cnico
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="technicianSLAStats">
                                    <div class="text-center">
                                        <div class="loading-spinner"></div>
                                        <p class="mt-2 text-muted">Cargando estad√≠sticas de SLA...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CSAT por T√©cnico -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-emoji-smile me-2"></i>Satisfacci√≥n del Cliente por T√©cnico
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="technicianCSATStats">
                                    <div class="text-center">
                                        <div class="loading-spinner"></div>
                                        <p class="mt-2 text-muted">Cargando estad√≠sticas de satisfacci√≥n...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tiempo de Resoluci√≥n por T√©cnico -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-clock-history me-2"></i>Tiempo de Resoluci√≥n por T√©cnico
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="technicianResolutionStats">
                                    <div class="text-center">
                                        <div class="loading-spinner"></div>
                                        <p class="mt-2 text-muted">Cargando estad√≠sticas de resoluci√≥n...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Validation Tab -->
            <div class="tab-pane fade" id="validation" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <h3 class="section-title">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            An√°lisis de Calidad de Datos
                        </h3>
                        <div id="validationInsights">
                            <div class="text-center">
                                <div class="loading-spinner"></div>
                                <p class="mt-2 text-muted">Analizando calidad de datos...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global chart configuration
        Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
        Chart.defaults.color = '#6c757d';
        Chart.defaults.plugins.tooltip.enabled = true;
        Chart.defaults.plugins.tooltip.mode = 'index';
        Chart.defaults.plugins.tooltip.intersect = false;

        // Global function to show values on charts
        const showValuesPlugin = {
            id: 'showValues',
            afterDatasetsDraw: function(chart, args, options) {
                if (options.display === false) return;
                
                const ctx = chart.ctx;
                ctx.save();
                
                chart.data.datasets.forEach((dataset, datasetIndex) => {
                    if (chart.getDatasetMeta(datasetIndex).hidden) return;
                    
                    const meta = chart.getDatasetMeta(datasetIndex);
                    meta.data.forEach((element, index) => {
                        const value = dataset.data[index];
                        if (value === 0 || value === null || value === undefined) return;
                        
                        // Configure text style
                        ctx.fillStyle = options.color || '#333';
                        ctx.font = options.font || 'bold 12px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        
                        // Position calculation
                        let x, y;
                        if (chart.config.type === 'bar' && chart.config.options.indexAxis === 'y') {
                            // Horizontal bar chart
                            x = element.x + 10;
                            y = element.y;
                        } else if (chart.config.type === 'bar') {
                            // Vertical bar chart
                            x = element.x;
                            y = element.y - 10;
                        } else if (chart.config.type === 'doughnut' || chart.config.type === 'pie') {
                            // Doughnut/Pie chart
                            const position = element.tooltipPosition();
                            x = position.x;
                            y = position.y;
                            ctx.fillStyle = 'white';
                            ctx.strokeStyle = '#333';
                            ctx.lineWidth = 2;
                        }
                        
                        // Draw value
                        if (chart.config.type === 'doughnut' || chart.config.type === 'pie') {
                            const total = dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            
                            ctx.strokeText(`${value}`, x, y - 8);
                            ctx.fillText(`${value}`, x, y - 8);
                            ctx.strokeText(`(${percentage}%)`, x, y + 8);
                            ctx.fillText(`(${percentage}%)`, x, y + 8);
                        } else {
                            ctx.fillText(value.toString(), x, y);
                        }
                    });
                });
                
                ctx.restore();
            }
        };

        // Register the plugin globally
        Chart.register(showValuesPlugin);

        const colors = {
            primary: '#dc3545',
            secondary: '#6c757d',
            success: '#28a745',
            warning: '#ffc107',
            info: '#17a2b8',
            light: '#f8f9fa',
            dark: '#343a40',
            orange: '#ff6b35'  // Color para tickets sin asignar
        };

        // Set current date
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Data storage
        let dashboardData = {};

        // Load all data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
        });

        async function loadDashboardData() {
            try {
                // Load all data in parallel
                const [metrics, distributions, technicians, requesters, sla, csat, validation, techSLA, techCSAT, techResolution] = await Promise.all([
                    fetch('/api/metrics').then(r => r.json()),
                    fetch('/api/distributions').then(r => r.json()),
                    fetch('/api/technicians').then(r => r.json()),
                    fetch('/api/requesters').then(r => r.json()),
                    fetch('/api/sla').then(r => r.json()),
                    fetch('/api/csat').then(r => r.json()),
                    fetch('/api/validation').then(r => r.json()),
                    fetch('/api/technicians/sla').then(r => r.json()),
                    fetch('/api/technicians/csat').then(r => r.json()),
                    fetch('/api/technicians/resolution-time').then(r => r.json())
                ]);

                dashboardData = {
                    metrics,
                    distributions,
                    technicians,
                    requesters,
                    sla,
                    csat,
                    validation,
                    technicianSLA: techSLA,
                    technicianCSAT: techCSAT,
                    technicianResolution: techResolution
                };

                updateDashboard();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showError('Error al cargar los datos del dashboard');
            }
        }

        function updateDashboard() {
            updateMetrics();
            updateCharts();
            updateAnalysis();
            updateTechnicianStats();
            updateValidation();
        }

        function updateMetrics() {
            const { metrics } = dashboardData;
            
            document.getElementById('totalTickets').textContent = metrics.total_tickets || 0;
            document.getElementById('resolutionRate').textContent = `${metrics.resolution_rate || 0}%`;
            document.getElementById('avgResolutionTime').textContent = metrics.avg_resolution_time_hours || 0;
            document.getElementById('slaCompliance').textContent = `${metrics.sla_compliance || 0}%`;
        }

        function updateCharts() {
            createTypeDistributionChart();
            createStatusDistributionChart();
            createPriorityChart();
            createTechnicianChart();
            createCSATChart();
            createCategoryChart();
        }

        function createTypeDistributionChart() {
            const ctx = document.getElementById('typeDistributionChart').getContext('2d');
            const data = dashboardData.distributions.by_type || {};
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: [colors.primary, colors.info],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.raw / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.raw} (${percentage}%)`;
                                }
                            }
                        },
                        showValues: {
                            display: true,
                            color: 'white',
                            font: 'bold 11px Arial'
                        }
                    }
                }
            });
        }

        function createStatusDistributionChart() {
            const ctx = document.getElementById('statusDistributionChart').getContext('2d');
            const data = dashboardData.distributions.by_status || {};
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: [colors.success, colors.primary, colors.warning, colors.info, colors.secondary],
                        borderWidth: 1,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.raw} tickets`;
                                }
                            }
                        },
                        showValues: {
                            display: true,
                            color: '#333',
                            font: 'bold 12px Arial'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createPriorityChart() {
            const ctx = document.getElementById('priorityChart').getContext('2d');
            const data = dashboardData.distributions.by_priority || {};
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: [colors.primary, colors.warning, colors.success],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.raw / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.raw} (${percentage}%)`;
                                }
                            }
                        },
                        showValues: {
                            display: true,
                            color: 'white',
                            font: 'bold 11px Arial'
                        }
                    }
                }
            });
        }

        function createTechnicianChart() {
    const ctx = document.getElementById('technicianChart').getContext('2d');
    const data = dashboardData.technicians || {};
    
    console.log('üîç Datos de t√©cnicos recibidos:', data);
    
    // Separar t√©cnicos asignados de tickets sin asignar
    const assignedTechnicians = {};
    let unassignedCount = 0;
    
    Object.entries(data).forEach(([name, count]) => {
        const normalizedName = (name || '').toString().trim().toLowerCase();
        
        if (normalizedName === 'sin asignar' || 
            normalizedName === '' || 
            normalizedName === 'null' || 
            normalizedName === 'n/a' ||
            normalizedName === 'none' ||
            name === null || 
            name === undefined) {
            unassignedCount += count;
        } else {
            assignedTechnicians[name] = count;
        }
    });
    
    // Ordenar t√©cnicos y agregar sin asignar
    const sortedTechnicians = Object.entries(assignedTechnicians)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 7);
    
    if (unassignedCount > 0) {
        sortedTechnicians.push(['SIN ASIGNAR', unassignedCount]);
    }
    
    // Crear gr√°fico con colores especiales para sin asignar
    const backgroundColors = sortedTechnicians.map(([name]) => 
        name === 'SIN ASIGNAR' ? '#ff6b35' : colors.primary
    );
    
    const labels = sortedTechnicians.map(([name]) => 
        name === 'SIN ASIGNAR' ? '‚ö†Ô∏è SIN ASIGNAR' : 
        (name.length > 18 ? name.substring(0, 18) + '...' : name)
    );
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                data: sortedTechnicians.map(([,count]) => count),
                backgroundColor: backgroundColors,
                borderColor: backgroundColors.map(color => 
                    color === '#ff6b35' ? '#e55a2b' : '#b02a37'
                ),
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: function(tooltipItem) {
                        const name = sortedTechnicians[tooltipItem.tooltip.dataPoints[0].dataIndex][0];
                        return name === 'SIN ASIGNAR' ? 'rgba(255, 107, 53, 0.95)' : 'rgba(0, 0, 0, 0.8)';
                    },
                    callbacks: {
                        title: function(context) {
                            const name = sortedTechnicians[context[0].dataIndex][0];
                            return name === 'SIN ASIGNAR' ? '‚ö†Ô∏è TICKETS SIN ASIGNAR' : name;
                        },
                        afterLabel: function(context) {
                            const name = sortedTechnicians[context.dataIndex][0];
                            return name === 'SIN ASIGNAR' ? ['', '‚ö†Ô∏è Requiere atenci√≥n inmediata'] : '';
                        }
                    }
                },
                showValues: {
                    display: true,
                    color: '#ffffff',
                    font: 'bold 12px Arial'
                }
            },
            scales: {
                x: { beginAtZero: true },
                y: {
                    grid: { display: false },
                    ticks: {
                        color: function(context) {
                            const name = sortedTechnicians[context.index][0];
                            return name === 'SIN ASIGNAR' ? '#ff6b35' : '#333333';
                        },
                        font: function(context) {
                            const name = sortedTechnicians[context.index][0];
                            return name === 'SIN ASIGNAR' ? 
                                { weight: 'bold', size: 12 } : 
                                { weight: 'normal', size: 11 };
                        }
                    }
                }
            }
        }
    });
    
    // Agregar alerta visual si hay tickets sin asignar
    if (unassignedCount > 0) {
        addUnassignedTicketsAlert(ctx.canvas.parentNode, unassignedCount);
    }
}

// Funci√≥n para agregar alerta
function addUnassignedTicketsAlert(container, count) {
    const existingAlert = container.querySelector('.unassigned-alert');
    if (existingAlert) existingAlert.remove();
    
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert unassigned-alert mt-3 mb-0';
    alertDiv.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
            <div>
                <strong>‚ö†Ô∏è Atenci√≥n requerida:</strong> 
                <span class="fw-bold">${count} ticket${count > 1 ? 's' : ''}</span> 
                sin asignar que necesita${count > 1 ? 'n' : ''} atenci√≥n inmediata.
            </div>
        </div>
    `;
    
    container.appendChild(alertDiv);
}

        function createCSATChart() {
            const ctx = document.getElementById('csatChart').getContext('2d');
            const data = dashboardData.csat || {};
            
            document.getElementById('csatScore').textContent = data.average_csat || '-';
            document.getElementById('csatSurveys').textContent = data.total_surveys || 0;
            
            if (data.distribution && Object.keys(data.distribution).length > 0) {
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(data.distribution).map(score => `${score} ‚≠ê`),
                        datasets: [{
                            data: Object.values(data.distribution),
                            backgroundColor: colors.primary,
                            borderWidth: 1,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.raw} encuestas`;
                                    }
                                }
                            },
                            showValues: {
                                display: true,
                                color: '#333',
                                font: 'bold 12px Arial'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        function createCategoryChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            const data = dashboardData.distributions.by_category || {};
            
            // Get top 10 categories
            const sortedCategories = Object.entries(data)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedCategories.map(([name]) => name.length > 20 ? name.substring(0, 20) + '...' : name),
                    datasets: [{
                        data: sortedCategories.map(([,count]) => count),
                        backgroundColor: colors.primary,
                        borderWidth: 1,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const categoryName = sortedCategories[context.dataIndex][0];
                                    return `${categoryName}: ${context.parsed.x} tickets`;
                                }
                            }
                        },
                        showValues: {
                            display: true,
                            color: '#333',
                            font: 'bold 12px Arial'
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateAnalysis() {
            updateTopRequesters();
            updateSLAAnalysis();
        }

        function updateTopRequesters() {
            const container = document.getElementById('topRequesters');
            const data = dashboardData.requesters || {};
            
            let html = '<div class="list-group list-group-flush">';
            Object.entries(data).forEach(([requester, count]) => {
                const displayName = requester.length > 25 ? requester.substring(0, 25) + '...' : requester;
                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span class="fw-medium">${displayName}</span>
                        <span class="badge badge-custom rounded-pill">${count}</span>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function updateSLAAnalysis() {
            const data = dashboardData.sla || {};
            
            document.getElementById('totalIncidents').textContent = data.total_incidents || 0;
            document.getElementById('slaExceeded').textContent = data.sla_exceeded || 0;
            
            const container = document.getElementById('slaLevels');
            const levels = data.sla_compliance_by_level || {};
            
            let html = '';
            Object.entries(levels).forEach(([level, levelData]) => {
                const complianceClass = levelData.compliance_rate >= 80 ? 'success' : 
                                      levelData.compliance_rate >= 60 ? 'warning' : 'danger';
                html += `
                    <div class="mb-2">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-medium">${level}</span>
                            <span class="text-${complianceClass}">${levelData.compliance_rate}%</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-${complianceClass}" 
                                 style="width: ${levelData.compliance_rate}%"></div>
                        </div>
                        <small class="text-muted">
                            ${levelData.within_sla} de ${levelData.total} tickets
                        </small>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p class="text-muted">No hay datos de SLA disponibles</p>';
        }

        function updateValidation() {
            const container = document.getElementById('validationInsights');
            const data = dashboardData.validation || {};
            
            let html = '';
            
            // Tickets sin asignar
            if (data.unassigned_tickets) {
                html += createInsightCard(
                    'Tickets Sin Asignar',
                    data.unassigned_tickets.count,
                    data.unassigned_tickets.recommendation,
                    'bi-person-x',
                    'warning'
                );
            }
            
            // Tickets sin categor√≠a
            if (data.no_category_tickets) {
                html += createInsightCard(
                    'Tickets Sin Categor√≠a',
                    data.no_category_tickets.count,
                    data.no_category_tickets.recommendation,
                    'bi-tag',
                    'info'
                );
            }
            
            // Hardware sin assets
            if (data.hardware_no_assets) {
                html += createInsightCard(
                    'Hardware Sin Elementos Asociados',
                    data.hardware_no_assets.count,
                    data.hardware_no_assets.recommendation,
                    'bi-pc-display',
                    'danger'
                );
            }
            
            container.innerHTML = html || '<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>No se encontraron problemas de calidad en los datos</div>';
        }

        function updateTechnicianStats() {
            updateTechnicianSLA();
            updateTechnicianCSAT();
            updateTechnicianResolution();
        }

       function updateTechnicianSLA() {
    const container = document.getElementById('technicianSLAStats');
    const data = dashboardData.technicianSLA || {};
    
    if (Object.keys(data).length === 0) {
        container.innerHTML = '<div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>No hay datos de SLA por t√©cnico disponibles</div>';
        return;
    }

    let html = '<div class="table-responsive"><table class="table table-striped">';
    html += `
        <thead>
            <tr>
                <th>T√©cnico</th>
                <th>Total Incidencias</th>
                <th>Cumplimiento SLA</th>
                <th>SLA Excedido</th>
                <th>% Cumplimiento</th>
                <th>Performance</th>
            </tr>
        </thead>
        <tbody>
    `;

    Object.entries(data).forEach(([technician, stats]) => {
        // Manejar valores undefined o faltantes
        const totalIncidents = stats.total_incidents || 0;
        const slaCompliant = stats.sla_compliant || 0;
        const slaExceeded = stats.sla_exceeded || 0;
        const complianceRate = stats.compliance_rate || 0;
        
        const performanceClass = complianceRate >= 90 ? 'success' : 
                               complianceRate >= 70 ? 'warning' : 'danger';
        const performanceIcon = complianceRate >= 90 ? 'bi-check-circle' : 
                              complianceRate >= 70 ? 'bi-exclamation-triangle' : 'bi-x-circle';
        
        html += `
            <tr>
                <td class="fw-medium">${technician.length > 30 ? technician.substring(0, 30) + '...' : technician}</td>
                <td><span class="badge bg-primary">${totalIncidents}</span></td>
                <td><span class="badge bg-success">${slaCompliant}</span></td>
                <td><span class="badge bg-danger">${slaExceeded}</span></td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="progress me-2" style="width: 60px; height: 6px;">
                            <div class="progress-bar bg-${performanceClass}" style="width: ${complianceRate}%"></div>
                        </div>
                        <span class="text-${performanceClass} fw-bold">${complianceRate.toFixed(1)}%</span>
                    </div>
                </td>
                <td>
                    <i class="bi ${performanceIcon} text-${performanceClass}"></i>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// Funci√≥n helper para validar y limpiar datos
function safeGetValue(obj, key, defaultValue = 0) {
    const value = obj && obj[key];
    return (value !== undefined && value !== null && !isNaN(value)) ? value : defaultValue;
}

// Funci√≥n helper para formatear n√∫meros
function safeFormatNumber(value, decimals = 1) {
    const num = parseFloat(value);
    return isNaN(num) ? '0' : num.toFixed(decimals);
}

        function updateTechnicianCSAT() {
    const container = document.getElementById('technicianCSATStats');
    const data = dashboardData.technicianCSAT || {};
    
    if (Object.keys(data).length === 0) {
        container.innerHTML = '<div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>No hay datos de satisfacci√≥n por t√©cnico disponibles</div>';
        return;
    }

    let html = '<div class="table-responsive"><table class="table table-striped">';
    html += `
        <thead>
            <tr>
                <th>T√©cnico</th>
                <th>Total Encuestas</th>
                <th>CSAT Promedio</th>
                <th>Excelentes (4-5‚≠ê)</th>
                <th>Pobres (1-2‚≠ê)</th>
                <th>Rating</th>
            </tr>
        </thead>
        <tbody>
    `;

    Object.entries(data).forEach(([technician, stats]) => {
        // Manejar valores undefined o faltantes
        const totalSurveys = stats.total_surveys || 0;
        const averageCsat = stats.average_csat || 0;
        const excellentRatings = stats.excellent_ratings || 0;
        const poorRatings = stats.poor_ratings || 0;
        
        const csatClass = averageCsat >= 4 ? 'success' : 
                        averageCsat >= 3 ? 'warning' : 'danger';
        const stars = '‚≠ê'.repeat(Math.round(averageCsat));
        
        html += `
            <tr>
                <td class="fw-medium">${technician.length > 30 ? technician.substring(0, 30) + '...' : technician}</td>
                <td><span class="badge bg-info">${totalSurveys}</span></td>
                <td>
                    <span class="text-${csatClass} fw-bold">${averageCsat.toFixed(1)}</span>
                    <small class="text-muted ms-1">${stars}</small>
                </td>
                <td><span class="badge bg-success">${excellentRatings}</span></td>
                <td><span class="badge bg-danger">${poorRatings}</span></td>
                <td>
                    <div class="progress" style="width: 80px; height: 6px;">
                        <div class="progress-bar bg-${csatClass}" style="width: ${(averageCsat / 5) * 100}%"></div>
                    </div>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
}

    function updateTechnicianResolution() {
    const container = document.getElementById('technicianResolutionStats');
    const data = dashboardData.technicianResolution || {};
    
    if (Object.keys(data).length === 0) {
        container.innerHTML = '<div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>No hay datos de tiempo de resoluci√≥n por t√©cnico disponibles</div>';
        return;
    }

    let html = '<div class="table-responsive"><table class="table table-striped">';
    html += `
        <thead>
            <tr>
                <th>T√©cnico</th>
                <th>Total Resueltos</th>
                <th>Tiempo Promedio</th>
                <th>M√≠n / M√°x</th>
                <th>R√°pidas (<24h)</th>
                <th>Lentas (>72h)</th>
                <th>Eficiencia</th>
            </tr>
        </thead>
        <tbody>
    `;

    Object.entries(data).forEach(([technician, stats]) => {
        // Manejar valores undefined o faltantes
        const totalResolved = stats.total_resolved || 0;
        const avgResolutionHours = stats.avg_resolution_hours || 0;
        const minResolutionHours = stats.min_resolution_hours || 0;
        const maxResolutionHours = stats.max_resolution_hours || 0;
        const fastResolutions = stats.fast_resolutions || 0;
        const slowResolutions = stats.slow_resolutions || 0;
        
        // Calcular eficiencia si no est√° disponible
        let efficiencyScore = stats.efficiency_score;
        if (efficiencyScore === undefined || efficiencyScore === null) {
            efficiencyScore = totalResolved > 0 ? (fastResolutions / totalResolved) * 100 : 0;
        }
        
        const efficiencyClass = efficiencyScore >= 70 ? 'success' : 
                              efficiencyScore >= 40 ? 'warning' : 'danger';
        
        html += `
            <tr>
                <td class="fw-medium">${technician.length > 30 ? technician.substring(0, 30) + '...' : technician}</td>
                <td><span class="badge bg-primary">${totalResolved}</span></td>
                <td class="fw-bold">${avgResolutionHours.toFixed(1)}h</td>
                <td>
                    <small class="text-muted">
                        ${minResolutionHours.toFixed(1)}h / ${maxResolutionHours.toFixed(1)}h
                    </small>
                </td>
                <td><span class="badge bg-success">${fastResolutions}</span></td>
                <td><span class="badge bg-warning">${slowResolutions}</span></td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="progress me-2" style="width: 60px; height: 6px;">
                            <div class="progress-bar bg-${efficiencyClass}" style="width: ${efficiencyScore}%"></div>
                        </div>
                        <span class="text-${efficiencyClass} fw-bold">${Math.round(efficiencyScore)}%</span>
                    </div>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
}


        function createInsightCard(title, count, recommendation, icon, type) {
            return `
                <div class="insight-item">
                    <div class="d-flex align-items-start">
                        <div class="me-3">
                            <i class="bi ${icon} fs-3 text-${type}"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="fw-bold mb-1">${title}</h6>
                            <p class="mb-2">
                                <span class="badge bg-${type}">${count} tickets</span>
                            </p>
                            <p class="mb-0 text-muted">
                                <i class="bi bi-lightbulb me-1"></i>
                                <strong>Recomendaci√≥n:</strong> ${recommendation}
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function showError(message) {
            const alertHtml = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.body.insertAdjacentHTML('afterbegin', alertHtml);
        }

        // Refresh data every 5 minutes
        setInterval(loadDashboardData, 5 * 60 * 1000);
    </script>
</body>
</html>