<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard IT - Clínica Bonsana</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        /* Estilos para tickets sin asignar */
        .unassigned-alert {
            border-left: 4px solid #ff6b35 !important;
            background: linear-gradient(90deg, #fff3e0 0%, #ffffff 100%) !important;
            border-color: #ff6b35 !important;
            animation: pulseWarning 3s ease-in-out infinite;
        }

        .unassigned-alert .bi-exclamation-triangle-fill {
            color: #ff6b35;
            animation: bounce 2s infinite;
        }

        /* Estilos para enlaces de tickets GLPI */
        .ticket-link {
            color: #0066cc !important;
            font-weight: 500;
            padding: 2px 4px;
            border-radius: 3px;
            transition: all 0.2s ease;
        }
        .ticket-link:hover {
            color: #004499 !important;
            background-color: #e6f3ff;
            text-decoration: underline !important;
        }
        
        @keyframes pulseWarning {
            0%, 100% { 
                border-left-color: #ff6b35;
                background: linear-gradient(90deg, #fff3e0 0%, #ffffff 100%);
            }
            50% { 
                border-left-color: #e55a2b;
                background: linear-gradient(90deg, #ffe0cc 0%, #ffffff 100%);
            }
        }

        @keyframes bounce {
            0%, 20%, 60%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-5px);
            }
            80% {
                transform: translateY(-2px);
            }
        }

        .metric-card.warning-highlight {
            border-left: 4px solid #ff6b35;
            background: linear-gradient(135deg, #fff8f0 0%, #ffffff 100%);
        }

        .metric-card.warning-highlight .metric-value {
            color: #ff6b35;
        }
        :root {
            --bonsana-red: #dc3545;
            --bonsana-red-light: #f8d7da;
            --bonsana-red-dark: #b02a37;
            --bonsana-white: #ffffff;
            --bonsana-gray-light: #f8f9fa;
            --bonsana-gray: #6c757d;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
        }

        body {
            background-color: var(--bonsana-gray-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: linear-gradient(135deg, var(--bonsana-red) 0%, var(--bonsana-red-dark) 100%) !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        .metric-card {
            background: linear-gradient(135deg, var(--bonsana-white) 0%, #fafafa 100%);
            height: 140px;
        }

        .metric-card .card-body {
            padding: 1.5rem;
            height: 100%;
            display: flex;
            align-items: center;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--bonsana-red);
        }

        .metric-label {
            color: var(--bonsana-gray);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-icon {
            font-size: 2rem;
            color: var(--bonsana-red);
            opacity: 0.8;
        }

        .section-title {
            color: var(--bonsana-red-dark);
            font-weight: bold;
            border-bottom: 3px solid var(--bonsana-red);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }

        .chart-container.small {
            height: 250px;
        }

        .alert-custom {
            border-left: 4px solid var(--bonsana-red);
            background-color: var(--bonsana-red-light);
            border-color: var(--bonsana-red);
        }

        .nav-pills .nav-link {
            color: var(--bonsana-red);
            border: 1px solid var(--bonsana-red);
            margin-right: 0.5rem;
        }

        .nav-pills .nav-link.active {
            background-color: var(--bonsana-red);
            border-color: var(--bonsana-red);
        }

        .nav-pills .nav-link:hover {
            background-color: var(--bonsana-red-light);
        }

        .table th {
            background-color: var(--bonsana-red);
            color: white;
            border: none;
        }

        .badge-custom {
            background-color: var(--bonsana-red);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(220, 53, 69, .3);
            border-radius: 50%;
            border-top-color: var(--bonsana-red);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .insight-item {
            border-left: 4px solid var(--bonsana-red);
            background-color: white;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0 8px 8px 0;
        }

        .trend-indicator {
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
        }

        .trend-up {
            background-color: var(--success-color);
            color: white;
        }

        /* Charts with values */
        .chart-container canvas {
            position: relative;
        }

        .chart-value {
            font-weight: bold;
            color: #333;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
        }

        .chart-value-white {
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        /* Better chart animations */
        .chart-container {
            animation: fadeIn 0.6s ease-in;
        }

        @keyframes chartValueFadeIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .chart-value {
            animation: chartValueFadeIn 0.8s ease-out 0.5s both;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-hospital me-2"></i>
                Clínica Bonsana - Dashboard IT
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text text-white">
                    <i class="bi bi-calendar-today me-1"></i>
                    <span id="currentDate"></span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Navigation Tabs -->
        <ul class="nav nav-pills mb-4" id="viewTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="pill" data-bs-target="#overview" type="button" role="tab">
                    <i class="bi bi-speedometer2 me-1"></i>Resumen General
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="analysis-tab" data-bs-toggle="pill" data-bs-target="#analysis" type="button" role="tab">
                    <i class="bi bi-graph-up me-1"></i>Análisis Detallado
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="technicians-tab" data-bs-toggle="pill" data-bs-target="#technicians" type="button" role="tab">
                    <i class="bi bi-people me-1"></i>Estadísticas por Técnico
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="validation-tab" data-bs-toggle="pill" data-bs-target="#validation" type="button" role="tab">
                    <i class="bi bi-exclamation-triangle me-1"></i>Validación de Datos
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="validation-tab" href="{{ url_for('ai_analysis') }}">
                    <i class="bi bi-robot me-1"></i> Análisis con IA Asistida
                </a>
            </li>

        </ul>

        <!-- File Upload Section - Collapsible -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-upload me-2 text-primary"></i>
                                <span class="fw-semibold">Subir Archivo GLPI CSV</span>
                                {% if csv_exists and csv_info %}
                                <small class="text-success ms-3">
                                    <i class="bi bi-check-circle me-1"></i>
                                    glpi.csv ({{ csv_info.columns if csv_info.columns else 0 }} columnas)
                                </small>
                                {% endif %}
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#uploadSection" aria-expanded="false" aria-controls="uploadSection">
                                <i class="bi bi-chevron-down" id="uploadToggleIcon"></i>
                            </button>
                        </div>
                    </div>
                    <div class="collapse" id="uploadSection">
                        <div class="card-body">
                            <p class="card-text text-muted mb-3">
                                Sube un archivo CSV exportado desde GLPI para actualizar los datos del dashboard.
                            </p>
                            <form id="csvUploadForm" enctype="multipart/form-data">
                                <div class="row align-items-end">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label for="csvFile" class="form-label">Seleccionar archivo CSV</label>
                                            <input type="file" class="form-control" id="csvFile" name="csv_file" accept=".csv" required>
                                            <div class="form-text">Solo archivos CSV. Tamaño máximo: 50MB</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <button type="submit" class="btn btn-primary w-100" id="uploadBtn">
                                                <i class="bi bi-upload me-2"></i>Subir Archivo
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            <div id="uploadProgress" class="mt-3" style="display: none;">
                                <div class="progress">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div id="uploadStatus" class="mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="tab-content" id="tabContent">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <!-- Key Metrics Row -->
                <div class="row mb-4">
                    <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
                        <div class="card metric-card">
                            <div class="card-body text-center">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="metric-value" id="totalTickets">-</div>
                                        <div class="metric-label">Total Tickets</div>
                                    </div>
                                    <i class="bi bi-ticket-perforated metric-icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
                        <div class="card metric-card">
                            <div class="card-body text-center">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="metric-value" id="resolutionRate">-</div>
                                        <div class="metric-label">Tasa de Resolución</div>
                                    </div>
                                    <i class="bi bi-check-circle metric-icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
                        <div class="card metric-card">
                            <div class="card-body text-center">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="metric-value" id="avgResolutionTime">-</div>
                                        <div class="metric-label">Tiempo Promedio (hrs)</div>
                                    </div>
                                    <i class="bi bi-clock-history metric-icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
                        <div class="card metric-card">
                            <div class="card-body text-center">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="metric-value" id="slaCompliance">-</div>
                                        <div class="metric-label">Cumplimiento SLA (Incidencias)</div>
                                    </div>
                                    <i class="bi bi-shield-check metric-icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
                        <div class="card metric-card">
                            <div class="card-body text-center">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="metric-value" id="csatMetric">-</div>
                                        <div class="metric-label">CSAT Alto (4-5★)</div>
                                        <small class="text-muted mt-1">
                                            <span id="csatMetricCount">-</span> de <span id="csatMetricTotal">-</span>
                                        </small>
                                    </div>
                                    <i class="bi bi-emoji-smile metric-icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
                        <div class="card metric-card">
                            <div class="card-body text-center">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="metric-value" id="preventiveMaintenanceCount">-</div>
                                        <div class="metric-label">Mantenimientos Preventivos</div>
                                    </div>
                                    <i class="bi bi-tools metric-icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row mb-4">
                    <div class="col-lg-6 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-pie-chart me-2"></i>Distribución por Tipo
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container small">
                                    <canvas id="typeDistributionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-bar-chart me-2"></i>Estado de Tickets
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container small">
                                    <canvas id="statusDistributionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Metrics Row -->
                <div class="row mb-4">
                    <div class="col-lg-4 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-exclamation-diamond me-2"></i>Distribución por Prioridad
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container small">
                                    <canvas id="priorityChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-people me-2"></i>Carga por Técnico
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container small">
                                    <canvas id="technicianChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-emoji-smile me-2"></i>Satisfacción del Cliente
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="text-center">
                                    <div class="metric-value" id="csatScore">-</div>
                                    <div class="metric-label">CSAT Alto (4-5★)</div>
                                    <small class="text-muted">
                                        <span id="csatHighCount">-</span> de <span id="csatSurveys">-</span> encuestas
                                    </small>
                                </div>
                                <div class="chart-container small mt-3">
                                    <canvas id="csatChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analysis Tab -->
            <div class="tab-pane fade" id="analysis" role="tabpanel">
                <!-- Resumen de Infraestructura Crítica -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-danger text-white">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-exclamation-triangle me-2"></i>Análisis de Infraestructura Crítica
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <!-- Email/Correo -->
                                    <div class="col-md-3 mb-3">
                                        <div class="border rounded p-3 h-100">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="bi bi-envelope-exclamation fs-4 text-danger me-2"></i>
                                                <h6 class="mb-0">Email/Correo</h6>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-end">
                                                <div>
                                                    <div class="display-6" id="emailIncidents">0</div>
                                                    <small class="text-muted">Incidencias</small>
                                                </div>
                                                <div class="text-end">
                                                    <small class="text-danger" id="emailCritical">0 críticas</small>
                                                </div>
                                            </div>
                                            <div class="mt-2">
                                                <small class="text-muted">Principal problema:</small>
                                                <small class="d-block text-truncate" id="emailTopIssue">Cuentas cerradas</small>
                                            </div>
                                            <div class="mt-1" id="emailCriticalIds" style="display: none;">
                                                <small class="text-danger">IDs críticos:</small>
                                                <small class="d-block" id="emailCriticalIdsList"></small>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- SQL/Base de Datos -->
                                    <div class="col-md-3 mb-3">
                                        <div class="border rounded p-3 h-100">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="bi bi-database-exclamation fs-4 text-warning me-2"></i>
                                                <h6 class="mb-0">SQL/Base de Datos</h6>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-end">
                                                <div>
                                                    <div class="display-6" id="sqlIncidents">0</div>
                                                    <small class="text-muted">Incidencias</small>
                                                </div>
                                                <div class="text-end">
                                                    <small class="text-warning" id="sqlCritical">0 críticas</small>
                                                </div>
                                            </div>
                                            <div class="mt-2">
                                                <small class="text-muted">Principal problema:</small>
                                                <small class="d-block text-truncate" id="sqlTopIssue">Inconsistencias SQL</small>
                                            </div>
                                            <div class="mt-1" id="sqlCriticalIds" style="display: none;">
                                                <small class="text-danger">IDs críticos:</small>
                                                <small class="d-block" id="sqlCriticalIdsList"></small>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Impresión -->
                                    <div class="col-md-3 mb-3">
                                        <div class="border rounded p-3 h-100">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="bi bi-printer fs-4 text-info me-2"></i>
                                                <h6 class="mb-0">Servicios de Impresión</h6>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-end">
                                                <div>
                                                    <div class="display-6" id="printIncidents">0</div>
                                                    <small class="text-muted">Incidencias</small>
                                                </div>
                                                <div class="text-end">
                                                    <small class="text-info" id="printCritical">0 críticas</small>
                                                </div>
                                            </div>
                                            <div class="mt-2">
                                                <small class="text-muted">Principal problema:</small>
                                                <small class="d-block text-truncate" id="printTopIssue">Fallas de impresora</small>
                                            </div>
                                            <div class="mt-1" id="printCriticalIds" style="display: none;">
                                                <small class="text-danger">IDs críticos:</small>
                                                <small class="d-block" id="printCriticalIdsList"></small>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Equipos/Red -->
                                    <div class="col-md-3 mb-3">
                                        <div class="border rounded p-3 h-100">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="bi bi-pc-display fs-4 text-success me-2"></i>
                                                <h6 class="mb-0">Equipos y Red</h6>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-end">
                                                <div>
                                                    <div class="display-6" id="equipmentIncidents">0</div>
                                                    <small class="text-muted">Incidencias</small>
                                                </div>
                                                <div class="text-end">
                                                    <small class="text-success" id="equipmentCritical">0 críticas</small>
                                                </div>
                                            </div>
                                            <div class="mt-2">
                                                <small class="text-muted">Principal problema:</small>
                                                <small class="d-block text-truncate" id="equipmentTopIssue">Conexión a Internet</small>
                                            </div>
                                            <div class="mt-1" id="equipmentCriticalIds" style="display: none;">
                                                <small class="text-danger">IDs críticos:</small>
                                                <small class="d-block" id="equipmentCriticalIdsList"></small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Equipos con Incidentes y Tiempo de Resolución -->
                <div class="row mb-4">
                    <div class="col-lg-6 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-pc-display-horizontal me-2"></i>Equipos con Más Incidentes
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="equipmentIncidentsList" style="max-height: 300px; overflow-y: auto;">
                                    <div class="text-center">
                                        <div class="loading-spinner"></div>
                                        <p class="mt-2 text-muted">Cargando equipos...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-clock-history me-2"></i>Tiempo de Resolución por Categoría
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="resolutionTimeByCategory">
                                    <div class="text-center">
                                        <div class="loading-spinner"></div>
                                        <p class="mt-2 text-muted">Cargando datos...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Patrones y Problemas Recurrentes -->
                <div class="row mb-4">
                    <div class="col-lg-8 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-arrow-repeat me-2"></i>Problemas Recurrentes y Patrones
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Problema</th>
                                                <th>Frecuencia</th>
                                                <th>Área Afectada</th>
                                                <th>Impacto</th>
                                                <th>Tendencia</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recurringProblems">
                                            <tr>
                                                <td colspan="5" class="text-center">
                                                    <div class="loading-spinner"></div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-person-lines-fill me-2"></i>Top 5 Usuarios
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="topAreas">
                                    <div class="text-center">
                                        <div class="loading-spinner"></div>
                                        <p class="mt-2 text-muted">Cargando datos...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SLA Analysis -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-shield-exclamation me-2"></i>Análisis de SLA
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-lg-6">
                                        <h6>Resumen de Incidencias</h6>
                                        <div class="row">
                                            <div class="col-6">
                                                <div class="text-center p-3 bg-light rounded">
                                                    <div class="h4 text-primary" id="totalIncidents">-</div>
                                                    <small>Total Incidencias</small>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="text-center p-3 bg-light rounded">
                                                    <div class="h4 text-danger" id="slaExceeded">-</div>
                                                    <small>SLA Excedido</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-6">
                                        <h6>Cumplimiento por Nivel de SLA</h6>
                                        <div id="slaLevels">
                                            <div class="text-center">
                                                <div class="loading-spinner"></div>
                                                <p class="mt-2 text-muted">Cargando análisis SLA...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Tickets con SLA Excedido -->
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <h6>Tickets que Excedieron SLA</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-striped">
                                                <thead>
                                                    <tr>
                                                        <th>ID</th>
                                                        <th>Título</th>
                                                        <th>Categoría</th>
                                                        <th>Técnico Asignado</th>
                                                        <th>Prioridad</th>
                                                        <th>Solicitante</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="slaExceededTickets">
                                                    <tr>
                                                        <td colspan="6" class="text-center">
                                                            <div class="loading-spinner"></div>
                                                            <p class="mt-2 text-muted">Cargando tickets...</p>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Technicians Tab -->
            <div class="tab-pane fade" id="technicians" role="tabpanel">
                <!-- SLA por Técnico -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-shield-check me-2"></i>Cumplimiento de SLA por Técnico
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="technicianSLAStats">
                                    <div class="text-center">
                                        <div class="loading-spinner"></div>
                                        <p class="mt-2 text-muted">Cargando estadísticas de SLA...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CSAT por Técnico -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-emoji-smile me-2"></i>Satisfacción del Cliente por Técnico
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="technicianCSATStats">
                                    <div class="text-center">
                                        <div class="loading-spinner"></div>
                                        <p class="mt-2 text-muted">Cargando estadísticas de satisfacción...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tiempo de Resolución por Técnico -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-clock-history me-2"></i>Tiempo de Resolución por Técnico
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="technicianResolutionStats">
                                    <div class="text-center">
                                        <div class="loading-spinner"></div>
                                        <p class="mt-2 text-muted">Cargando estadísticas de resolución...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Validation Tab -->
            <div class="tab-pane fade" id="validation" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <h3 class="section-title">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Análisis de Calidad de Datos
                        </h3>
                        <div id="validationInsights">
                            <div class="text-center">
                                <div class="loading-spinner"></div>
                                <p class="mt-2 text-muted">Analizando calidad de datos...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global variables
        let glpiBaseUrl = 'http://192.168.0.92:8080'; // Default value
        
        // Load GLPI configuration
        async function loadGLPIConfig() {
            try {
                const response = await fetch('/api/config');
                if (response.ok) {
                    const config = await response.json();
                    glpiBaseUrl = config.glpi_base_url || 'http://192.168.0.92:8080';
                }
            } catch (error) {
                console.error('Error loading GLPI config:', error);
            }
        }
        
        // Function to create GLPI ticket links
        function createGLPILinks(ticketIds, baseUrl = glpiBaseUrl) {
            if (!ticketIds || ticketIds.length === 0) return '';
            
            return ticketIds.map(id => {
                const url = `${baseUrl}/front/ticket.form.php?id=${id}`;
                return `<a href="${url}" target="_blank" class="ticket-link text-decoration-none text-primary">${id}</a>`;
            }).join(', ');
        }
        
        // Global chart configuration
        Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
        Chart.defaults.color = '#6c757d';
        Chart.defaults.plugins.tooltip.enabled = true;
        Chart.defaults.plugins.tooltip.mode = 'index';
        Chart.defaults.plugins.tooltip.intersect = false;

        // Global function to show values on charts
        const showValuesPlugin = {
            id: 'showValues',
            afterDatasetsDraw: function(chart, args, options) {
                if (options.display === false) return;
                
                const ctx = chart.ctx;
                ctx.save();
                
                chart.data.datasets.forEach((dataset, datasetIndex) => {
                    if (chart.getDatasetMeta(datasetIndex).hidden) return;
                    
                    const meta = chart.getDatasetMeta(datasetIndex);
                    meta.data.forEach((element, index) => {
                        const value = dataset.data[index];
                        if (value === 0 || value === null || value === undefined) return;
                        
                        // Configure text style
                        ctx.fillStyle = options.color || '#333';
                        ctx.font = options.font || 'bold 12px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        
                        // Position calculation
                        let x, y;
                        if (chart.config.type === 'bar' && chart.config.options.indexAxis === 'y') {
                            // Horizontal bar chart
                            x = element.x + 10;
                            y = element.y;
                        } else if (chart.config.type === 'bar') {
                            // Vertical bar chart
                            x = element.x;
                            y = element.y - 10;
                        } else if (chart.config.type === 'doughnut' || chart.config.type === 'pie') {
                            // Doughnut/Pie chart
                            const position = element.tooltipPosition();
                            x = position.x;
                            y = position.y;
                            ctx.fillStyle = 'white';
                            ctx.strokeStyle = '#333';
                            ctx.lineWidth = 2;
                        }
                        
                        // Draw value
                        if (chart.config.type === 'doughnut' || chart.config.type === 'pie') {
                            const total = dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            
                            ctx.strokeText(`${value}`, x, y - 8);
                            ctx.fillText(`${value}`, x, y - 8);
                            ctx.strokeText(`(${percentage}%)`, x, y + 8);
                            ctx.fillText(`(${percentage}%)`, x, y + 8);
                        } else {
                            ctx.fillText(value.toString(), x, y);
                        }
                    });
                });
                
                ctx.restore();
            }
        };

        // Register the plugin globally
        Chart.register(showValuesPlugin);

        const colors = {
            primary: '#dc3545',
            secondary: '#6c757d',
            success: '#28a745',
            warning: '#ffc107',
            info: '#17a2b8',
            light: '#f8f9fa',
            dark: '#343a40',
            orange: '#ff6b35'  // Color para tickets sin asignar
        };

        // Set current date
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Data storage
        let dashboardData = {};

        // File upload functionality
        function setupFileUpload() {
            const form = document.getElementById('csvUploadForm');
            const fileInput = document.getElementById('csvFile');
            const uploadBtn = document.getElementById('uploadBtn');
            const progressContainer = document.getElementById('uploadProgress');
            const progressBar = progressContainer.querySelector('.progress-bar');
            const statusContainer = document.getElementById('uploadStatus');

            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const file = fileInput.files[0];
                if (!file) {
                    showUploadStatus('error', 'Por favor selecciona un archivo CSV');
                    return;
                }

                // Validate file type
                if (!file.name.toLowerCase().endsWith('.csv')) {
                    showUploadStatus('error', 'Solo se permiten archivos CSV');
                    return;
                }

                // Validate file size (50MB max)
                const maxSize = 50 * 1024 * 1024; // 50MB
                if (file.size > maxSize) {
                    showUploadStatus('error', 'El archivo es demasiado grande. Máximo 50MB');
                    return;
                }

                // Prepare upload
                const formData = new FormData();
                formData.append('csv_file', file);

                // Show progress
                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Subiendo...';
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                statusContainer.innerHTML = '';

                try {
                    // Simulate progress for user feedback
                    let progress = 0;
                    const progressInterval = setInterval(() => {
                        progress += Math.random() * 30;
                        if (progress > 90) progress = 90;
                        progressBar.style.width = progress + '%';
                    }, 100);

                    // Upload file
                    const response = await fetch('/upload-csv', {
                        method: 'POST',
                        body: formData
                    });

                    clearInterval(progressInterval);
                    progressBar.style.width = '100%';

                    const result = await response.json();

                    if (result.success) {
                        showUploadStatus('success', result.message);
                        if (result.file_info) {
                            const info = result.file_info;
                            showUploadStatus('info', 
                                `Archivo: ${info.filename} (${info.size_mb} MB, ${info.columns} columnas)`
                            );
                        }
                        
                        // Reload dashboard data after successful upload
                        setTimeout(() => {
                            loadDashboardData();
                            showUploadStatus('info', 'Datos del dashboard actualizados');
                        }, 2000);
                        
                        // Reset form
                        form.reset();
                        
                    } else {
                        showUploadStatus('error', result.error || 'Error subiendo archivo');
                    }

                } catch (error) {
                    console.error('Upload error:', error);
                    showUploadStatus('error', 'Error de conexión. Intenta nuevamente.');
                    progressBar.style.width = '0%';
                } finally {
                    // Reset button
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '<i class="bi bi-upload me-2"></i>Subir Archivo';
                    
                    // Hide progress after delay
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                    }, 3000);
                }
            });

            // File input change handler
            fileInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    statusContainer.innerHTML = '';
                    if (!file.name.toLowerCase().endsWith('.csv')) {
                        showUploadStatus('warning', 'Asegúrate de que sea un archivo CSV');
                    }
                }
            });
        }

        function showUploadStatus(type, message) {
            const statusContainer = document.getElementById('uploadStatus');
            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'warning': 'alert-warning',
                'info': 'alert-info'
            }[type] || 'alert-info';
            
            const icon = {
                'success': 'bi-check-circle',
                'error': 'bi-exclamation-triangle',
                'warning': 'bi-exclamation-triangle',
                'info': 'bi-info-circle'
            }[type] || 'bi-info-circle';

            statusContainer.innerHTML = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <i class="bi ${icon} me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        function setupCollapsibleUpload() {
            const uploadSection = document.getElementById('uploadSection');
            const toggleIcon = document.getElementById('uploadToggleIcon');
            
            uploadSection.addEventListener('show.bs.collapse', function () {
                toggleIcon.classList.remove('bi-chevron-down');
                toggleIcon.classList.add('bi-chevron-up');
            });
            
            uploadSection.addEventListener('hide.bs.collapse', function () {
                toggleIcon.classList.remove('bi-chevron-up');
                toggleIcon.classList.add('bi-chevron-down');
            });
        }

        // Load all data on page load
        document.addEventListener('DOMContentLoaded', async function() {
            await loadGLPIConfig();
            loadDashboardData();
            setupFileUpload();
            setupCollapsibleUpload();
        });

        async function loadDashboardData() {
            try {
                console.log('🔄 Loading dashboard data...');
                
                // Load all data in parallel
                const [metrics, distributions, technicians, requesters, sla, csat, validation, techSLA, techCSAT, techResolution, infrastructure, recurringProblems, resolutionTimeByCategory, topAffectedAreas, slaExceededTickets, equipmentIncidents] = await Promise.all([
                    fetch('/api/metrics').then(r => r.json()),
                    fetch('/api/distributions').then(r => r.json()),
                    fetch('/api/technicians').then(r => r.json()),
                    fetch('/api/requesters').then(r => r.json()),
                    fetch('/api/sla').then(r => r.json()),
                    fetch('/api/csat').then(r => r.json()),
                    fetch('/api/validation').then(r => r.json()),
                    fetch('/api/technicians/sla').then(r => r.json()),
                    fetch('/api/technicians/csat').then(r => r.json()),
                    fetch('/api/technicians/resolution-time').then(r => r.json()),
                    fetch('/api/infrastructure').then(r => r.json()).catch(e => {console.error('Infrastructure API error:', e); return {};}),
                    fetch('/api/recurring-problems').then(r => r.json()).catch(e => {console.error('Recurring problems API error:', e); return [];}),
                    fetch('/api/resolution-time-by-category').then(r => r.json()).catch(e => {console.error('Resolution time API error:', e); return {};}),
                    fetch('/api/top-affected-areas').then(r => r.json()).catch(e => {console.error('Top areas API error:', e); return [];}),
                    fetch('/api/sla-exceeded-tickets').then(r => r.json()).catch(e => {console.error('SLA exceeded tickets API error:', e); return [];}),
                    fetch('/api/equipment-incidents').then(r => r.json()).catch(e => {console.error('Equipment incidents API error:', e); return [];})
                ]);

                console.log('✅ All data loaded:', {infrastructure, recurringProblems, resolutionTimeByCategory, topAffectedAreas});

                dashboardData = {
                    metrics,
                    distributions,
                    technicians,
                    requesters,
                    sla,
                    csat,
                    validation,
                    technicianSLA: techSLA,
                    technicianCSAT: techCSAT,
                    technicianResolution: techResolution,
                    infrastructure,
                    recurringProblems,
                    resolutionTimeByCategory,
                    topAffectedAreas,
                    slaExceededTickets,
                    equipmentIncidents
                };

                updateDashboard();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showError('Error al cargar los datos del dashboard');
            }
        }

        function updateDashboard() {
            updateMetrics();
            updateCharts();
            updateAnalysis();
            updateTechnicianStats();
            updateValidation();
        }

        function updateMetrics() {
            const { metrics } = dashboardData;
            
            document.getElementById('totalTickets').textContent = metrics.total_tickets || 0;
            document.getElementById('resolutionRate').textContent = `${metrics.resolution_rate || 0}%`;
            document.getElementById('avgResolutionTime').textContent = metrics.avg_resolution_time_hours || 0;
            document.getElementById('slaCompliance').textContent = `${metrics.sla_compliance || 0}%`;
            document.getElementById('csatMetric').textContent = `${metrics.csat_percentage || 0}%`;
            document.getElementById('csatMetricCount').textContent = metrics.high_satisfaction_count || 0;
            document.getElementById('csatMetricTotal').textContent = metrics.total_surveys || 0;
            document.getElementById('preventiveMaintenanceCount').textContent = metrics.preventive_maintenance_count || 0;
        }

        function updateCharts() {
            createTypeDistributionChart();
            createStatusDistributionChart();
            createPriorityChart();
            createTechnicianChart();
            createCSATChart();
        }

        function createTypeDistributionChart() {
            const ctx = document.getElementById('typeDistributionChart').getContext('2d');
            const data = dashboardData.distributions.by_type || {};
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: [colors.primary, colors.info],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.raw / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.raw} (${percentage}%)`;
                                }
                            }
                        },
                        showValues: {
                            display: true,
                            color: 'white',
                            font: 'bold 11px Arial'
                        }
                    }
                }
            });
        }

        function createStatusDistributionChart() {
            const ctx = document.getElementById('statusDistributionChart').getContext('2d');
            const data = dashboardData.distributions.by_status || {};
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: [colors.success, colors.primary, colors.warning, colors.info, colors.secondary],
                        borderWidth: 1,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.raw} tickets`;
                                }
                            }
                        },
                        showValues: {
                            display: true,
                            color: '#333',
                            font: 'bold 12px Arial'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createPriorityChart() {
            const ctx = document.getElementById('priorityChart').getContext('2d');
            const data = dashboardData.distributions.by_priority || {};
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: [colors.primary, colors.warning, colors.success],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.raw / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.raw} (${percentage}%)`;
                                }
                            }
                        },
                        showValues: {
                            display: true,
                            color: 'white',
                            font: 'bold 11px Arial'
                        }
                    }
                }
            });
        }

        function createTechnicianChart() {
    const ctx = document.getElementById('technicianChart').getContext('2d');
    const data = dashboardData.technicians || {};
    
    console.log('🔍 Datos de técnicos recibidos:', data);
    
    // Separar técnicos asignados de tickets sin asignar
    const assignedTechnicians = {};
    let unassignedCount = 0;
    
    Object.entries(data).forEach(([name, count]) => {
        const normalizedName = (name || '').toString().trim().toLowerCase();
        
        if (normalizedName === 'sin asignar' || 
            normalizedName === '' || 
            normalizedName === 'null' || 
            normalizedName === 'n/a' ||
            normalizedName === 'none' ||
            name === null || 
            name === undefined) {
            unassignedCount += count;
        } else {
            assignedTechnicians[name] = count;
        }
    });
    
    // Ordenar técnicos y agregar sin asignar
    const sortedTechnicians = Object.entries(assignedTechnicians)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 7);
    
    if (unassignedCount > 0) {
        sortedTechnicians.push(['SIN ASIGNAR', unassignedCount]);
    }
    
    // Crear gráfico con colores especiales para sin asignar
    const backgroundColors = sortedTechnicians.map(([name]) => 
        name === 'SIN ASIGNAR' ? '#ff6b35' : colors.primary
    );
    
    const labels = sortedTechnicians.map(([name]) => 
        name === 'SIN ASIGNAR' ? '⚠️ SIN ASIGNAR' : 
        (name.length > 18 ? name.substring(0, 18) + '...' : name)
    );
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                data: sortedTechnicians.map(([,count]) => count),
                backgroundColor: backgroundColors,
                borderColor: backgroundColors.map(color => 
                    color === '#ff6b35' ? '#e55a2b' : '#b02a37'
                ),
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: function(tooltipItem) {
                        const name = sortedTechnicians[tooltipItem.tooltip.dataPoints[0].dataIndex][0];
                        return name === 'SIN ASIGNAR' ? 'rgba(255, 107, 53, 0.95)' : 'rgba(0, 0, 0, 0.8)';
                    },
                    callbacks: {
                        title: function(context) {
                            const name = sortedTechnicians[context[0].dataIndex][0];
                            return name === 'SIN ASIGNAR' ? '⚠️ TICKETS SIN ASIGNAR' : name;
                        },
                        afterLabel: function(context) {
                            const name = sortedTechnicians[context.dataIndex][0];
                            return name === 'SIN ASIGNAR' ? ['', '⚠️ Requiere atención inmediata'] : '';
                        }
                    }
                },
                showValues: {
                    display: true,
                    color: '#ffffff',
                    font: 'bold 12px Arial'
                }
            },
            scales: {
                x: { beginAtZero: true },
                y: {
                    grid: { display: false },
                    ticks: {
                        color: function(context) {
                            const name = sortedTechnicians[context.index][0];
                            return name === 'SIN ASIGNAR' ? '#ff6b35' : '#333333';
                        },
                        font: function(context) {
                            const name = sortedTechnicians[context.index][0];
                            return name === 'SIN ASIGNAR' ? 
                                { weight: 'bold', size: 12 } : 
                                { weight: 'normal', size: 11 };
                        }
                    }
                }
            }
        }
    });
    
    // Agregar alerta visual si hay tickets sin asignar
    if (unassignedCount > 0) {
        addUnassignedTicketsAlert(ctx.canvas.parentNode, unassignedCount);
    }
}

// Función para agregar alerta
function addUnassignedTicketsAlert(container, count) {
    const existingAlert = container.querySelector('.unassigned-alert');
    if (existingAlert) existingAlert.remove();
    
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert unassigned-alert mt-3 mb-0';
    alertDiv.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
            <div>
                <strong>⚠️ Atención requerida:</strong> 
                <span class="fw-bold">${count} ticket${count > 1 ? 's' : ''}</span> 
                sin asignar que necesita${count > 1 ? 'n' : ''} atención inmediata.
            </div>
        </div>
    `;
    
    container.appendChild(alertDiv);
}

        function createCSATChart() {
            const ctx = document.getElementById('csatChart').getContext('2d');
            const data = dashboardData.csat || {};
            
            // Actualizar métricas - CORREGIDO: mostrar porcentaje de alta satisfacción
            document.getElementById('csatScore').textContent = `${data.csat_percentage || 0}%`;
            document.getElementById('csatSurveys').textContent = data.total_surveys || 0;
            document.getElementById('csatHighCount').textContent = data.high_satisfaction_count || 0;
            
            if (data.distribution && Object.keys(data.distribution).length > 0) {
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(data.distribution).map(score => `${score} ⭐`),
                        datasets: [{
                            data: Object.values(data.distribution),
                            backgroundColor: colors.primary,
                            borderWidth: 1,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.raw} encuestas`;
                                    }
                                }
                            },
                            showValues: {
                                display: true,
                                color: '#333',
                                font: 'bold 12px Arial'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }
        

        function updateAnalysis() {
            updateInfrastructureMetrics();
            updateRecurringProblems();
            updateResolutionTimeByCategory();
            updateEquipmentIncidents();
            updateTopAffectedAreas();
            updateSLAAnalysis();
            updateSLAExceededTickets();
        }

        function updateInfrastructureMetrics() {
            const data = dashboardData.infrastructure || {};
            console.log('🔍 Infrastructure data received:', data);
            console.log('🔍 Dashboard data structure:', dashboardData);
            
            // Debug: Check if elements exist
            console.log('🔍 Checking if DOM elements exist:');
            console.log('emailIncidents element:', document.getElementById('emailIncidents'));
            console.log('sqlIncidents element:', document.getElementById('sqlIncidents'));
            console.log('printIncidents element:', document.getElementById('printIncidents'));
            console.log('equipmentIncidents element:', document.getElementById('equipmentIncidents'));
            
            // Update Email metrics
            const emailData = data.email || {};
            const emailElement = document.getElementById('emailIncidents');
            if (emailElement) {
                emailElement.textContent = emailData.total_incidents || 0;
                console.log('✅ Updated emailIncidents to:', emailData.total_incidents);
            } else {
                console.error('❌ emailIncidents element not found');
            }
            
            const emailCriticalElement = document.getElementById('emailCritical');
            if (emailCriticalElement) {
                emailCriticalElement.textContent = `${emailData.critical_incidents || 0} críticas`;
            }
            
            const emailTopIssueElement = document.getElementById('emailTopIssue');
            if (emailTopIssueElement) {
                emailTopIssueElement.textContent = emailData.top_issue || 'Sin datos';
            }
            
            // Update critical IDs for Email
            const emailCriticalIds = emailData.critical_ticket_ids || [];
            const emailCriticalIdsContainer = document.getElementById('emailCriticalIds');
            const emailCriticalIdsList = document.getElementById('emailCriticalIdsList');
            if (emailCriticalIds.length > 0 && emailCriticalIdsContainer && emailCriticalIdsList) {
                emailCriticalIdsList.innerHTML = createGLPILinks(emailCriticalIds);
                emailCriticalIdsContainer.style.display = 'block';
            } else if (emailCriticalIdsContainer) {
                emailCriticalIdsContainer.style.display = 'none';
            }
            
            // Update SQL metrics
            const sqlData = data.sql || {};
            const sqlElement = document.getElementById('sqlIncidents');
            if (sqlElement) {
                sqlElement.textContent = sqlData.total_incidents || 0;
                console.log('✅ Updated sqlIncidents to:', sqlData.total_incidents);
            } else {
                console.error('❌ sqlIncidents element not found');
            }
            
            const sqlCriticalElement = document.getElementById('sqlCritical');
            if (sqlCriticalElement) {
                sqlCriticalElement.textContent = `${sqlData.critical_incidents || 0} críticas`;
            }
            
            const sqlTopIssueElement = document.getElementById('sqlTopIssue');
            if (sqlTopIssueElement) {
                sqlTopIssueElement.textContent = sqlData.top_issue || 'Sin datos';
            }
            
            // Update critical IDs for SQL
            const sqlCriticalIds = sqlData.critical_ticket_ids || [];
            const sqlCriticalIdsContainer = document.getElementById('sqlCriticalIds');
            const sqlCriticalIdsList = document.getElementById('sqlCriticalIdsList');
            if (sqlCriticalIds.length > 0 && sqlCriticalIdsContainer && sqlCriticalIdsList) {
                sqlCriticalIdsList.innerHTML = createGLPILinks(sqlCriticalIds);
                sqlCriticalIdsContainer.style.display = 'block';
            } else if (sqlCriticalIdsContainer) {
                sqlCriticalIdsContainer.style.display = 'none';
            }
            
            // Update Print metrics
            const printData = data.print || {};
            const printElement = document.getElementById('printIncidents');
            if (printElement) {
                printElement.textContent = printData.total_incidents || 0;
                console.log('✅ Updated printIncidents to:', printData.total_incidents);
            } else {
                console.error('❌ printIncidents element not found');
            }
            
            const printCriticalElement = document.getElementById('printCritical');
            if (printCriticalElement) {
                printCriticalElement.textContent = `${printData.critical_incidents || 0} críticas`;
            }
            
            const printTopIssueElement = document.getElementById('printTopIssue');
            if (printTopIssueElement) {
                printTopIssueElement.textContent = printData.top_issue || 'Sin datos';
            }
            
            // Update critical IDs for Print
            const printCriticalIds = printData.critical_ticket_ids || [];
            const printCriticalIdsContainer = document.getElementById('printCriticalIds');
            const printCriticalIdsList = document.getElementById('printCriticalIdsList');
            if (printCriticalIds.length > 0 && printCriticalIdsContainer && printCriticalIdsList) {
                printCriticalIdsList.innerHTML = createGLPILinks(printCriticalIds);
                printCriticalIdsContainer.style.display = 'block';
            } else if (printCriticalIdsContainer) {
                printCriticalIdsContainer.style.display = 'none';
            }
            
            // Update Equipment metrics
            const equipmentData = data.equipment || {};
            const equipmentElement = document.getElementById('equipmentIncidents');
            if (equipmentElement) {
                equipmentElement.textContent = equipmentData.total_incidents || 0;
                console.log('✅ Updated equipmentIncidents to:', equipmentData.total_incidents);
            } else {
                console.error('❌ equipmentIncidents element not found');
            }
            
            const equipmentCriticalElement = document.getElementById('equipmentCritical');
            if (equipmentCriticalElement) {
                equipmentCriticalElement.textContent = `${equipmentData.critical_incidents || 0} críticas`;
            }
            
            const equipmentTopIssueElement = document.getElementById('equipmentTopIssue');
            if (equipmentTopIssueElement) {
                equipmentTopIssueElement.textContent = equipmentData.top_issue || 'Sin datos';
            }
            
            // Update critical IDs for Equipment
            const equipmentCriticalIds = equipmentData.critical_ticket_ids || [];
            const equipmentCriticalIdsContainer = document.getElementById('equipmentCriticalIds');
            const equipmentCriticalIdsList = document.getElementById('equipmentCriticalIdsList');
            if (equipmentCriticalIds.length > 0 && equipmentCriticalIdsContainer && equipmentCriticalIdsList) {
                equipmentCriticalIdsList.innerHTML = createGLPILinks(equipmentCriticalIds);
                equipmentCriticalIdsContainer.style.display = 'block';
            } else if (equipmentCriticalIdsContainer) {
                equipmentCriticalIdsContainer.style.display = 'none';
            }
        }

        function updateRecurringProblems() {
            const container = document.getElementById('recurringProblems');
            const problems = dashboardData.recurringProblems || [];
            
            if (problems.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">No se encontraron problemas recurrentes</td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            problems.forEach(problem => {
                const impactClass = problem.impact === 'alto' ? 'danger' : 
                                  problem.impact === 'medio' ? 'warning' : 'success';
                const trendIcon = problem.trend === 'creciente' ? 'bi-arrow-up text-danger' :
                                problem.trend === 'decreciente' ? 'bi-arrow-down text-success' :
                                'bi-arrow-right text-warning';
                
                html += `
                    <tr>
                        <td class="fw-medium">${problem.problem}</td>
                        <td><span class="badge bg-primary">${problem.frequency}</span></td>
                        <td><span class="badge bg-info">${problem.area}</span></td>
                        <td><span class="badge bg-${impactClass}">${problem.impact}</span></td>
                        <td><i class="${trendIcon}"></i> ${problem.trend}</td>
                    </tr>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateResolutionTimeByCategory() {
            const container = document.getElementById('resolutionTimeByCategory');
            const data = dashboardData.resolutionTimeByCategory || {};
            
            if (Object.keys(data).length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="bi bi-clock-history display-6"></i>
                        <p class="mt-2">No hay datos disponibles</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="list-group list-group-flush">';
            Object.entries(data).forEach(([category, categoryData]) => {
                const avgHours = categoryData.avg_hours || 0;
                const count = categoryData.count || 0;
                const timeClass = avgHours > 24 ? 'danger' : avgHours > 12 ? 'warning' : 'success';
                
                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-medium">${category}</div>
                            <small class="text-muted">${count} tickets</small>
                        </div>
                        <span class="badge bg-${timeClass}">${avgHours}h</span>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function updateEquipmentIncidents() {
            const container = document.getElementById('equipmentIncidentsList');
            const equipments = dashboardData.equipmentIncidents || [];
            
            if (equipments.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="bi bi-pc-display display-6"></i>
                        <p class="mt-2">No se encontraron equipos con incidentes</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="list-group list-group-flush">';
            equipments.forEach((equipment, index) => {
                const rankClass = index < 3 ? 'text-danger fw-bold' : index < 5 ? 'text-warning fw-bold' : '';
                const badgeClass = index < 3 ? 'bg-danger' : index < 5 ? 'bg-warning' : 'bg-primary';
                const icon = index < 3 ? 'bi-exclamation-triangle-fill' : index < 5 ? 'bi-exclamation-circle-fill' : 'bi-pc-display';
                
                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                        <div class="d-flex align-items-center">
                            <i class="${icon} me-2 ${rankClass}"></i>
                            <div>
                                <div class="fw-medium ${rankClass}">${equipment.equipment}</div>
                                <small class="text-muted">${equipment.category}</small>
                            </div>
                        </div>
                        <span class="badge ${badgeClass}">${equipment.incident_count} incidentes</span>
                    </div>
                `;
            });
            html += '</div>';
            
            // Agregar resumen al final
            if (equipments.length > 10) {
                html += `
                    <div class="text-center mt-2">
                        <small class="text-muted">Mostrando top ${equipments.length} equipos con más incidentes</small>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function updateTopAffectedAreas() {
            const container = document.getElementById('topAreas');
            const areas = dashboardData.topAffectedAreas || [];
            
            if (areas.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="bi bi-building display-6"></i>
                        <p class="mt-2">No hay datos disponibles</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="list-group list-group-flush">';
            areas.forEach(area => {
                html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="fw-medium">${area.area}</div>
                            <span class="badge bg-primary">${area.incident_count}</span>
                        </div>
                        <div class="progress mt-2" style="height: 4px;">
                            <div class="progress-bar" style="width: ${area.percentage}%"></div>
                        </div>
                        <small class="text-muted">${area.percentage}% del total</small>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function updateSLAAnalysis() {
            const data = dashboardData.sla || {};
            
            document.getElementById('totalIncidents').textContent = data.total_incidents || 0;
            document.getElementById('slaExceeded').textContent = data.sla_exceeded || 0;
            
            const container = document.getElementById('slaLevels');
            const levels = data.sla_compliance_by_level || {};
            
            let html = '';
            Object.entries(levels).forEach(([level, levelData]) => {
                const complianceClass = levelData.compliance_rate >= 80 ? 'success' : 
                                      levelData.compliance_rate >= 60 ? 'warning' : 'danger';
                html += `
                    <div class="mb-2">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-medium">${level}</span>
                            <span class="text-${complianceClass}">${levelData.compliance_rate}%</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-${complianceClass}" 
                                 style="width: ${levelData.compliance_rate}%"></div>
                        </div>
                        <small class="text-muted">
                            ${levelData.within_sla} de ${levelData.total} tickets
                        </small>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p class="text-muted">No hay datos de SLA disponibles</p>';
        }

        function updateValidation() {
            const container = document.getElementById('validationInsights');
            const data = dashboardData.validation || {};
            
            let html = '';
            
            // Tickets sin asignar
            if (data.unassigned_tickets) {
                html += createInsightCard(
                    'Tickets Sin Asignar',
                    data.unassigned_tickets.count,
                    data.unassigned_tickets.recommendation,
                    'bi-person-x',
                    'warning'
                );
            }
            
            // Tickets sin categoría
            if (data.no_category_tickets) {
                html += createInsightCard(
                    'Tickets Sin Categoría',
                    data.no_category_tickets.count,
                    data.no_category_tickets.recommendation,
                    'bi-tag',
                    'info'
                );
            }
            
            // Hardware sin assets
            if (data.hardware_no_assets) {
                html += createInsightCard(
                    'Hardware Sin Elementos Asociados',
                    data.hardware_no_assets.count,
                    data.hardware_no_assets.recommendation,
                    'bi-pc-display',
                    'danger'
                );
            }
            
            container.innerHTML = html || '<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>No se encontraron problemas de calidad en los datos</div>';
        }
        
        function updateSLAExceededTickets() {
            const container = document.getElementById('slaExceededTickets');
            const tickets = dashboardData.slaExceededTickets || [];
            
            console.log('🔍 updateSLAExceededTickets called');
            console.log('🔍 Container found:', !!container);
            console.log('🔍 Tickets data:', tickets);
            console.log('🔍 Tickets length:', tickets.length);
            
            if (tickets.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-success">
                            <i class="bi bi-check-circle me-2"></i>No hay tickets que hayan excedido el SLA
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            tickets.forEach(ticket => {
                const priority = ticket.priority === null || ticket.priority === 'NaN' || typeof ticket.priority === 'undefined' ? 'Sin definir' : ticket.priority;
                const category = ticket.category === null || ticket.category === 'NaN' || typeof ticket.category === 'undefined' ? 'Sin categoría' : ticket.category;
                const technician = ticket.technician === null || ticket.technician === 'NaN' || typeof ticket.technician === 'undefined' ? 'Sin asignar' : ticket.technician;
                const requester = ticket.requester === null || ticket.requester === 'NaN' || typeof ticket.requester === 'undefined' ? 'Sin datos' : ticket.requester;
                const title = ticket.title === null || ticket.title === 'NaN' || typeof ticket.title === 'undefined' ? 'Sin título' : ticket.title;
                
                const priorityClass = priority && priority.toLowerCase().includes('crítica') ? 'text-danger' :
                                   priority && priority.toLowerCase().includes('alta') ? 'text-warning' : '';
                
                html += `
                    <tr>
                        <td><strong>${ticket.id}</strong></td>
                        <td class="text-truncate" style="max-width: 200px;" title="${title}">${title}</td>
                        <td class="text-truncate" style="max-width: 150px;" title="${category}">${category}</td>
                        <td>${technician}</td>
                        <td class="${priorityClass}">${priority}</td>
                        <td class="text-truncate" style="max-width: 120px;" title="${requester}">${requester}</td>
                    </tr>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateTechnicianStats() {
            updateTechnicianSLA();
            updateTechnicianCSAT();
            updateTechnicianResolution();
        }

       function updateTechnicianSLA() {
    const container = document.getElementById('technicianSLAStats');
    const data = dashboardData.technicianSLA || {};
    
    if (Object.keys(data).length === 0) {
        container.innerHTML = '<div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>No hay datos de SLA por técnico disponibles</div>';
        return;
    }

    let html = '<div class="table-responsive"><table class="table table-striped">';
    html += `
        <thead>
            <tr>
                <th>Técnico</th>
                <th>Total Incidencias</th>
                <th>Cumplimiento SLA</th>
                <th>SLA Excedido</th>
                <th>% Cumplimiento</th>
                <th>Performance</th>
            </tr>
        </thead>
        <tbody>
    `;

    Object.entries(data).forEach(([technician, stats]) => {
        // Manejar valores undefined o faltantes
        const totalIncidents = stats.total_incidents || 0;
        const slaCompliant = stats.sla_compliant || 0;
        const slaExceeded = stats.sla_exceeded || 0;
        const complianceRate = stats.compliance_rate || 0;
        
        const performanceClass = complianceRate >= 90 ? 'success' : 
                               complianceRate >= 70 ? 'warning' : 'danger';
        const performanceIcon = complianceRate >= 90 ? 'bi-check-circle' : 
                              complianceRate >= 70 ? 'bi-exclamation-triangle' : 'bi-x-circle';
        
        html += `
            <tr>
                <td class="fw-medium">${technician.length > 30 ? technician.substring(0, 30) + '...' : technician}</td>
                <td><span class="badge bg-primary">${totalIncidents}</span></td>
                <td><span class="badge bg-success">${slaCompliant}</span></td>
                <td><span class="badge bg-danger">${slaExceeded}</span></td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="progress me-2" style="width: 60px; height: 6px;">
                            <div class="progress-bar bg-${performanceClass}" style="width: ${complianceRate}%"></div>
                        </div>
                        <span class="text-${performanceClass} fw-bold">${complianceRate.toFixed(1)}%</span>
                    </div>
                </td>
                <td>
                    <i class="bi ${performanceIcon} text-${performanceClass}"></i>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// Función helper para validar y limpiar datos
function safeGetValue(obj, key, defaultValue = 0) {
    const value = obj && obj[key];
    return (value !== undefined && value !== null && !isNaN(value)) ? value : defaultValue;
}

// Función helper para formatear números
function safeFormatNumber(value, decimals = 1) {
    const num = parseFloat(value);
    return isNaN(num) ? '0' : num.toFixed(decimals);
}

        function updateTechnicianCSAT() {
    const container = document.getElementById('technicianCSATStats');
    const data = dashboardData.technicianCSAT || {};
    
    if (Object.keys(data).length === 0) {
        container.innerHTML = '<div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>No hay datos de satisfacción por técnico disponibles</div>';
        return;
    }

    let html = '<div class="table-responsive"><table class="table table-striped">';
    html += `
        <thead>
            <tr>
                <th>Técnico</th>
                <th>Total Encuestas</th>
                <th>CSAT Promedio</th>
                <th>Excelentes (4-5⭐)</th>
                <th>Pobres (1-2⭐)</th>
                <th>Rating</th>
            </tr>
        </thead>
        <tbody>
    `;

    Object.entries(data).forEach(([technician, stats]) => {
        // Manejar valores undefined o faltantes
        const totalSurveys = stats.total_surveys || 0;
        const averageCsat = stats.average_csat || 0;
        const excellentRatings = stats.excellent_ratings || 0;
        const poorRatings = stats.poor_ratings || 0;
        
        const csatClass = averageCsat >= 4 ? 'success' : 
                        averageCsat >= 3 ? 'warning' : 'danger';
        const stars = '⭐'.repeat(Math.round(averageCsat));
        
        html += `
            <tr>
                <td class="fw-medium">${technician.length > 30 ? technician.substring(0, 30) + '...' : technician}</td>
                <td><span class="badge bg-info">${totalSurveys}</span></td>
                <td>
                    <span class="text-${csatClass} fw-bold">${averageCsat.toFixed(1)}</span>
                    <small class="text-muted ms-1">${stars}</small>
                </td>
                <td><span class="badge bg-success">${excellentRatings}</span></td>
                <td><span class="badge bg-danger">${poorRatings}</span></td>
                <td>
                    <div class="progress" style="width: 80px; height: 6px;">
                        <div class="progress-bar bg-${csatClass}" style="width: ${(averageCsat / 5) * 100}%"></div>
                    </div>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
}

    function updateTechnicianResolution() {
    const container = document.getElementById('technicianResolutionStats');
    const data = dashboardData.technicianResolution || {};
    
    if (Object.keys(data).length === 0) {
        container.innerHTML = '<div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>No hay datos de tiempo de resolución por técnico disponibles</div>';
        return;
    }

    let html = '<div class="table-responsive"><table class="table table-striped">';
    html += `
        <thead>
            <tr>
                <th>Técnico</th>
                <th>Total Resueltos</th>
                <th>Tiempo Promedio</th>
                <th>Mín / Máx</th>
                <th>Rápidas (<24h)</th>
                <th>Lentas (>72h)</th>
                <th>Eficiencia</th>
            </tr>
        </thead>
        <tbody>
    `;

    Object.entries(data).forEach(([technician, stats]) => {
        // Manejar valores undefined o faltantes
        const totalResolved = stats.total_resolved || 0;
        const avgResolutionHours = stats.avg_resolution_hours || 0;
        const minResolutionHours = stats.min_resolution_hours || 0;
        const maxResolutionHours = stats.max_resolution_hours || 0;
        const fastResolutions = stats.fast_resolutions || 0;
        const slowResolutions = stats.slow_resolutions || 0;
        
        // Calcular eficiencia si no está disponible
        let efficiencyScore = stats.efficiency_score;
        if (efficiencyScore === undefined || efficiencyScore === null) {
            efficiencyScore = totalResolved > 0 ? (fastResolutions / totalResolved) * 100 : 0;
        }
        
        const efficiencyClass = efficiencyScore >= 70 ? 'success' : 
                              efficiencyScore >= 40 ? 'warning' : 'danger';
        
        html += `
            <tr>
                <td class="fw-medium">${technician.length > 30 ? technician.substring(0, 30) + '...' : technician}</td>
                <td><span class="badge bg-primary">${totalResolved}</span></td>
                <td class="fw-bold">${avgResolutionHours.toFixed(1)}h</td>
                <td>
                    <small class="text-muted">
                        ${minResolutionHours.toFixed(1)}h / ${maxResolutionHours.toFixed(1)}h
                    </small>
                </td>
                <td><span class="badge bg-success">${fastResolutions}</span></td>
                <td><span class="badge bg-warning">${slowResolutions}</span></td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="progress me-2" style="width: 60px; height: 6px;">
                            <div class="progress-bar bg-${efficiencyClass}" style="width: ${efficiencyScore}%"></div>
                        </div>
                        <span class="text-${efficiencyClass} fw-bold">${Math.round(efficiencyScore)}%</span>
                    </div>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
}


        function createInsightCard(title, count, recommendation, icon, type) {
            return `
                <div class="insight-item">
                    <div class="d-flex align-items-start">
                        <div class="me-3">
                            <i class="bi ${icon} fs-3 text-${type}"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="fw-bold mb-1">${title}</h6>
                            <p class="mb-2">
                                <span class="badge bg-${type}">${count} tickets</span>
                            </p>
                            <p class="mb-0 text-muted">
                                <i class="bi bi-lightbulb me-1"></i>
                                <strong>Recomendación:</strong> ${recommendation}
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function showError(message) {
            const alertHtml = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.body.insertAdjacentHTML('afterbegin', alertHtml);
        }

        // Refresh data every 5 minutes
        setInterval(loadDashboardData, 5 * 60 * 1000);
    </script>
</body>
</html>